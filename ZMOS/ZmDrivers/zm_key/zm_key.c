/*****************************************************************
* Copyright (C) 2021 zm. All rights reserved.                    *
******************************************************************
* zm_key.c
*
* DESCRIPTION:
*     zm key driver.
* AUTHOR:
*     zm
* CREATED DATE:
*     2021/6/7
* REVISION:
*     v0.1
*
* MODIFICATION HISTORY
* --------------------
* $Log:$
*
*****************************************************************/
 
/*************************************************************************************************************************
 *                                                       INCLUDES                                                        *
 *************************************************************************************************************************/
#include "ZMOS.h"
#include "zm_drivers.h"
#include <string.h>
#include "zm_key.h"

#if ZM_KEY_MAX_NUM > 0
/*************************************************************************************************************************
 *                                                        MACROS                                                         *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                      CONSTANTS                                                        *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                       TYPEDEFS                                                        *
 *************************************************************************************************************************/
typedef struct
{
    uint8_t active;
    zmKeyEvent_t event;
    zmKeyEventCb funcCb;
}zmKeyStatus_t;

/*************************************************************************************************************************
 *                                                   GLOBAL VARIABLES                                                    *
 *************************************************************************************************************************/
static zmKeyStatus_t keyStatusTable[ZM_KEY_MAX_NUM];
/*************************************************************************************************************************
 *                                                  EXTERNAL VARIABLES                                                   *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                    LOCAL VARIABLES                                                    *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                 FUNCTION DECLARATIONS                                                 *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                   PUBLIC FUNCTIONS                                                    *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                    LOCAL FUNCTIONS                                                    *
 *************************************************************************************************************************/
/*****************************************************************
* FUNCTION: zm_keyInit
*
* DESCRIPTION:
*     key driver initialize.
* INPUTS:
*     null
* RETURNS:
*     null
* NOTE:
*     null
*****************************************************************/
void zm_keyInit(void)
{
    memset(keyStatusTable, 0, sizeof(zmKeyStatus_t) * ZM_KEY_MAX_NUM);
}
/*****************************************************************
* FUNCTION: zm_keyRegister
*
* DESCRIPTION:
*     This function to register key.
*     When key was pressed, callback will be call.
* INPUTS:
*     key : Bit mask value of keys to register.
*     keyActive : The level at which the key is pressed.
*                 0 : active low.
*                 1 : active high.
*     keyCallback £º key callback function.
* RETURNS:
*     null
* NOTE:
*     null
*****************************************************************/
void zm_keyRegister(zmKeyType_t keys, uint8_t keyActive, zmKeyEventCb keyCallback)
{
    if(keys >= BS(ZM_KEY_MAX_NUM)) return;
    zmKeyType_t key;
    zmKeyStatus_t *stu;
    
    key = ZM_KEY_1;
    stu = keyStatusTable;
    
    while(keys)
    {
        if(keys & key)
        {
            stu->active = keyActive;
            stu->funcCb = keyCallback;
            memset(stu, 0, sizeof(zmKeyStatus_t));
            keys ^= key;
        }
        key <<= 1;
        stu++;
    }
}
/*****************************************************************
* FUNCTION: zm_keyPollStart
*
* DESCRIPTION:
*     This function to start key poll.
* INPUTS:
*     period : key poll period.
* RETURNS:
*     null
* NOTE:
*     null
*****************************************************************/
void zm_keyPollStart(uint32_t period)
{
    zmDriverSetTimerEvent(ZM_DRIVER_KEY_POLL_EVENT, period, true);
}
/*****************************************************************
* FUNCTION: zm_keyPollStop
*
* DESCRIPTION:
*     This function to stop key poll.
* INPUTS:
*     null
* RETURNS:
*     null
* NOTE:
*     null
*****************************************************************/
void zm_keyPollStop(void)
{
    zmDriverStopTimerEvent(ZM_DRIVER_KEY_POLL_EVENT);
}
/*****************************************************************
* FUNCTION: zm_keyPollProcess
*
* DESCRIPTION:
*     This function to poll key press.
* INPUTS:
*     null
* RETURNS:
*     null
* NOTE:
*     null
*****************************************************************/
void zm_keyPollProcess(void)
{
    zmKeyType_t key;
    zmKeyType_t keys;
    zmKeyStatus_t *stu;
    
    key = ZM_KEY_1;
    keys = BS(ZM_KEY_MAX_NUM) - 1;
    stu = keyStatusTable;
    
    while(keys)
    {
        if(keys & key)
        {
            
            keys ^= key;
        }
        key <<= 1;
        stu++;
    }
}
#else

#endif
/****************************************************** END OF FILE ******************************************************/
