/*****************************************************************
* Copyright (C) 2021 zm. All rights reserved.                    *
******************************************************************
* bsp_clock.c
*
* DESCRIPTION:
*     Provide clock tick for ZMOS.
* AUTHOR:
*     zm
* CREATED DATE:
*     2021/6/11
* REVISION:
*     v0.1
*
* MODIFICATION HISTORY
* --------------------
* $Log:$
*
*****************************************************************/
 
/*************************************************************************************************************************
 *                                                       INCLUDES                                                        *
 *************************************************************************************************************************/
#include "definitions.h"
#include "bsp_clock.h"
#include "common.h"
/*************************************************************************************************************************
 *                                                        MACROS                                                         *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                      CONSTANTS                                                        *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                       TYPEDEFS                                                        *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                   GLOBAL VARIABLES                                                    *
 *************************************************************************************************************************/
static uint32_t clockTick = 0;
/*************************************************************************************************************************
 *                                                  EXTERNAL VARIABLES                                                   *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                    LOCAL VARIABLES                                                    *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                 FUNCTION DECLARATIONS                                                 *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                   PUBLIC FUNCTIONS                                                    *
 *************************************************************************************************************************/
 
/*************************************************************************************************************************
 *                                                    LOCAL FUNCTIONS                                                    *
 *************************************************************************************************************************/
/*****************************************************************
* FUNCTION: tickUpdate
*
* DESCRIPTION:
*     null
* INPUTS:
*     null
* RETURNS:
*     null
* NOTE:
*     null
*****************************************************************/
static void tickUpdate(TC_TIMER_STATUS status, uintptr_t context)
{
    clockTick++;
}
/*****************************************************************
* FUNCTION: timerClockWakeupInit
*
* DESCRIPTION:
*     .
* INPUTS:
*     null
* RETURNS:
*     null
* NOTE:
*     null
*****************************************************************/
void timerClockWakeupInit(void)
{
    /* Selection of the Generator and write Lock for TC0 TC1 */
    GCLK_REGS->GCLK_PCHCTRL[14] = GCLK_PCHCTRL_GEN(0x0)  | GCLK_PCHCTRL_CHEN_Msk;

    while ((GCLK_REGS->GCLK_PCHCTRL[14] & GCLK_PCHCTRL_CHEN_Msk) != GCLK_PCHCTRL_CHEN_Msk)
    {
        /* Wait for synchronization */
    }
}
/*****************************************************************
* FUNCTION: timerClockLowPowerInit
*
* DESCRIPTION:
*     .
* INPUTS:
*     null
* RETURNS:
*     null
* NOTE:
*     null
*****************************************************************/
void timerClockLowPowerInit(void)
{
    /* Selection of the Generator and write Lock for TC0 TC1 */
    GCLK_REGS->GCLK_PCHCTRL[14] = GCLK_PCHCTRL_GEN(0x2)  | GCLK_PCHCTRL_CHEN_Msk;
    
    while ((GCLK_REGS->GCLK_PCHCTRL[14] & GCLK_PCHCTRL_CHEN_Msk) != GCLK_PCHCTRL_CHEN_Msk)
    {
        /* Wait for synchronization */
    }
}

/*****************************************************************
* FUNCTION: bsp_getClockCount
*
* DESCRIPTION:
*     Clock initialize.
* INPUTS:
*     null
* RETURNS:
*     Clock count.
* NOTE:
*     null
*****************************************************************/
void bsp_clockInit(void)
{
    uint32_t timerPeriod;
    TC0_TimerStop();
    timerPeriod = TC0_TimerFrequencyGet() / 1000/*000*/;  // to us
    //timerPeriod *= SYSTEM_CLOCK_US;
    TC0_Timer32bitPeriodSet(timerPeriod);
    TC0_Timer32bitCounterSet(0);
    TC0_TimerCallbackRegister(tickUpdate, 0);
    TC0_TimerStart();
}
/*****************************************************************
* FUNCTION: bsp_getClockCount
*
* DESCRIPTION:
*     Get clock count, it provide system clock for ZMOS.
* INPUTS:
*     null
* RETURNS:
*     Clock count.
* NOTE:
*     null
*****************************************************************/
uint32_t bsp_getClockCount(void)
{
    return clockTick;
}
/*****************************************************************
* FUNCTION: bsp_compensateClockCount
*
* DESCRIPTION:
*     Compensate clock count.
* INPUTS:
*     Compensate value.
* RETURNS:
*     null
* NOTE:
*     null
*****************************************************************/
void bsp_compensateClockCount(uint32_t value)
{
    clockTick += value;
}
/****************************************************** END OF FILE ******************************************************/
